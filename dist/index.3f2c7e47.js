class t{constructor(t,e,s){let i=function(t){let e=0;for(let s=0;s<t.length;s++)e=(e<<5)-e+t.charCodeAt(s),e&=e;return e}(JSON.stringify(t));this.type=e,this.domId=`notification-${i}`,this.container=document.body,this.template=document.getElementById("notification-template").content,this._bindEventListeners(),s&&this.autoDismiss()}_bindEventListeners(){window.addEventListener("keydown",t=>{"Escape"===t.key&&this.hide()})}autoDismiss(){setTimeout(()=>{this.hide()},2e3)}static show(e,s){let i=new t(e,s);return i.show(e),i}static initialize(){let e=console.error;console.error=function(...s){t.show(s),e.apply(console,s)}}static handleApplicationError(e){console.debug("caught error"),console.error(e),t.show(e)}show(t){let e=this.template.cloneNode(!0),s=e.querySelector(".notification");if(!s){console.error("Notification root element not found in template");return}e.querySelector(".notification-message").textContent=t,s.id=this.domId,this.type&&s.classList.add(`notification-${this.type}`),e.querySelector(".close-notification-button").onclick=()=>this.hide(),document.getElementById(this.domId)||this.container.appendChild(e)}hide(){document.getElementById(this.domId)?.remove()}}class e{static set(t,e){try{let s=JSON.stringify(e);localStorage.setItem(t,s)}catch(t){console.error("Error saving to localStorage",t)}}static get(t,e=null){try{let s=localStorage.getItem(t);return null!==s?JSON.parse(s):e}catch(t){return console.error("Error reading from localStorage",t),e}}static remove(t){try{localStorage.removeItem(t)}catch(t){console.error("Error removing from localStorage",t)}}static getUrl(t){try{let s=e.get("url");if(t)return new URL(t,s).href;return s}catch(t){return null}}static setUrl(t){e.set("url",t)}static getModel(){return e.get("model")}static setModel(t){e.set("model",t)}static getSystemPrompt(){return e.get("system-prompt")}static setSystemPrompt(t){""===t&&(t=null),e.set("system-prompt",t)}static getModelParameters(){return e.get("model-parameters")}static setModelParameters(t){""===t&&(t=null),e.set("model-parameters",t)}static getCurrentChatId(){return e.get("currentChatId")}static setCurrentChatId(t){void 0===t&&(t=null),e.set("currentChatId",t)}}class s{static listen(t,e,s){null==s&&(s=window),s.addEventListener(t,t=>{e(t.detail)})}static emit(t,e,s){null==s&&(s=window);let i=`${t}`;e?.id&&(i+=` id: ${e.id}`),console.log(i);let a=new CustomEvent(t,{detail:e||{},bubbles:!0});s.dispatchEvent(a)}}class i{static showElement(t){return t.classList.remove("hidden"),this}static hideElement(t){return t.classList.add("hidden"),this}static enableInput(t){return t.removeAttribute("disabled"),this}static disableInput(t){return t.setAttribute("disabled","disabled"),this}}function a(t,e){let s;return function(...i){clearTimeout(s),s=setTimeout(()=>{clearTimeout(s),t(...i)},e)}}class n{constructor(t,e,s){this.dbName=t,this.objectStores=e,this.dbConnection=null,this.migrations=s}async open(){if(this.dbConnection)throw Error("Connection already open");return new Promise((t,e)=>{let s=indexedDB.open(this.dbName,this.migrations.version);s.onerror=t=>e(t.target.error),s.onupgradeneeded=t=>{let e=t.target.result,s=t.currentTarget.transaction;this.migrations.upgrade(e,s,t.oldVersion)},s.onsuccess=e=>{this.dbConnection=e.target.result,t(this.dbConnection)}})}async transaction(t,e){return this.dbConnection.transaction([t],e).objectStore(t)}async add(t,e){let s=await this.transaction(t,"readwrite");return this.handleRequest("add",s.add(e))}async get(t,e){let s=await this.transaction(t,"readonly");return this.handleRequest("get",s.get(e))}async put(t,e){let s=await this.transaction(t,"readwrite");return this.handleRequest("put",s.put(e))}async delete(t,e){let s=await this.transaction(t,"readwrite");return this.handleRequest("delete",s.delete(e))}async getAll(t){let e=await this.transaction(t,"readwrite");return this.handleRequest("getAll",e.getAll())}async clear(t){let e=await this.transaction(t,"readwrite");return this.handleRequest("deleteAll",e.clear())}handleRequest(t,e){return new Promise((s,i)=>{e.onsuccess=()=>s(e.result),e.onerror=e=>{i(Error(JSON.stringify(`Database ${t} operation failed: ${e.target.error.message}`)))}})}}class r{static version=2;static upgrade(t,e,s){console.debug(`Migration needed. Old version ${s}. New version ${this.version}.`);let i=`upgradeToVersion${this.version}`,a=this[i];if(!a)throw Error(`Upgrade function missing for ${i}`);this.version>=s&&a({database:t,transaction:e})}static upgradeToVersion2(t){t.database.createObjectStore("chats",{keyPath:"id",autoIncrement:!0}),t.database.createObjectStore("chat_messages",{keyPath:"id",autoIncrement:!0}).createIndex("by_chat","chatId",{unique:!1})}}class l{constructor(t){Object.assign(this,t)}async create(){let t=await this.constructor.db.add(this.constructor.storeName,this);return this.id||(this.id=t),this}async save(){return await this.constructor.db.put(this.constructor.storeName,this)}async delete(){return await this.constructor.db.delete(this.constructor.storeName,this.id)}jsonify(){return JSON.stringify(this)}static async database(t,e){this.dbName=t,this.storeName=e,this.db=new n(t,[e],r),await this.db.open()}static async transaction(t){return await this.db.transaction(this.storeName,t)}async transaction(t){return await this.constructor.transaction(t)}static async get(t){return new this(await this.db.get(this.storeName,t))}static async clear(){return await this.db.clear(this.storeName)}static async getAll(){return(await this.db.getAll(this.storeName)).map(t=>new this(t))}static async getAllByIndexAndId(t,e){let s=(await this.transaction("readonly")).index(t).getAll(e);return new Promise((t,e)=>{s.onsuccess=()=>{t(s.result.map(t=>new this(t)))},s.onerror=()=>{e(s.error)}})}static async export(){let t=await this.db.transaction(this.storeName,"readonly");return(await t.transaction.objectStore(this.storeName)).getAll()}}class o extends l{static async initialize(){await this.database("ChatApp","chat_messages")}static async getAllByChatId(t){return this.getAllByIndexAndId("by_chat",t)}}class d extends l{async addMessage(t){return t.chatId=this.id,await new o(t).create()}async getMessages(){let t=await o.getAllByChatId(this.id);return this.messages=t,this.messages}static async initialize(){await this.database("ChatApp",["chats"])}static async clear(){await o.clear(),await super.clear()}static async get(t){return await super.get(t)}static async delete(t){for(let e of(await super.delete(t),await o.getAllByChatId(t)))await e.delete()}}class h{static showElement(t){return t.classList.remove("hidden"),this}static hideElement(t){return t.classList.add("hidden"),this}static enableInput(t){return t.removeAttribute("disabled"),this}static disableInput(t){return t.setAttribute("disabled","disabled"),this}}class c{constructor(t){this.element=t}show(){h.showElement(this.element)}hide(){h.hideElement(this.element)}}class u extends c{constructor(t,e){super(t),this.ul=t,this.items=e,this.render(),this.clickHandler=null,this.ul.classList.add("list")}onClick(t){return this.clickHandler=t,this}setItems(t){this.items=t,this.render()}setSelected(t){console.debug(`Select ${t}`),this.selected=t,this.li.forEach(e=>{e.textContent===t?e.classList.add("selected"):e.classList.remove("selected")}),s.emit("select",t,this.ul)}getSelected(){return this.selected}render(){this.ul.innerHTML="",this.li=this.items.map(t=>{let e=document.createElement("li");return e.classList.add("list-item"),t===this.selected&&e.classList.add("selected"),e.textContent=t,e.item=t,e.addEventListener("click",()=>{this.setSelected(t),this.clickHandler&&this.clickHandler(t)}),this.ul.appendChild(e),e})}}class m extends u{constructor(t,e){super(t,e),this.div=document.createElement("small"),this.div.classList.add("hidden","p-2"),this.ul.prepend(this.div),this.query=null}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}render(){super.render()}filter(t){if(this.query=t,null==t)return this.clearFilter(),this.filtered=!1,null;let e=this.escapeRegExp(t).replace(/\s+/g,".*"),s=RegExp(e,"i"),i=this.li.map(t=>{let e=t.textContent;return s.test(e)?(h.showElement(t),e):(h.hideElement(t),null)}).filter(t=>t);console.log(`Search ${e}. Matches: ${i}`),h.showElement(this.div);let a=null;return a=t.length<1?"Continue typing to search models. Showing all models:":0!=i.length?`Found ${i.length} model(s) matching '${this.query}'. Click to change chat's model, or press tab to change prompt's model:`:`Did not find any models that match '${this.query}'.`,this.div.textContent=a,i}clearFilter(){h.hideElement(this.div),this.query=null,this.li.forEach(t=>{h.showElement(t)})}}class g{constructor(){this.abortController=null}async makeRequest(t,e,s,i,a){let n={prompt:s,model:e,messages:(await t.getMessages()).map(t=>({role:t.role,content:t.content}))};return i&&(n.system=i),a&&(n.options=a),n}async send(t,e,s,i,a){let n={data:e};try{let i=await this.postChatMessage(t,e);await this.handleResponse(n,i,s,a)}catch(t){i(n,t)}}async postChatMessage(t,e){this.abortController=new AbortController;let{signal:s}=this.abortController,i=await fetch(t,{signal:s,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok)throw Error(`${t} failed with status ${i.status}`);return i}async handleResponse(t,e,s,i){let a=e.body.getReader(),n="";for(var r=!1;!r;){let{done:l,value:o}=await a.read();if(l){i(t,e),r=!0;continue}let d=(n+new TextDecoder().decode(o)).split("\n");n=d.pop(),d.forEach(e=>{let i=JSON.parse(e);e.trim()&&(this.printResponseStats(i),s(t,i.message.content))})}n.trim()&&s(t,n)}abort(){this.abortController&&this.abortController.abort()}printResponseStats(t){if(!t.total_duration)return;let e=t.total_duration/1e9,s=t.load_duration/1e9,i=t.prompt_eval_duration/1e9,a=t.eval_duration/1e9,n=t.eval_count/a;console.log(`
Model: ${t.model}
Created At: ${t.created_at}
Total Duration (s): ${e.toFixed(2)}
Load Duration (s): ${s.toFixed(2)}
Prompt Evaluation Count: ${t.prompt_eval_count}
Prompt Evaluation Duration (s): ${i.toFixed(2)}
Response Evaluation Count: ${t.eval_count}
Response Evaluation Duration (s): ${a.toFixed(2)}
Tokens Per Second: ${n.toFixed(2)} token/s
    `)}static getModels(t,e){return t?fetch(t).then(e=>{if(!e.ok)throw Error(`Unable to fetch models from ${t}`);return e.json()}).then(t=>{e(t.models)}).catch(s=>{console.debug(s),console.error(`Please ensure the server is running at: ${t}. Error code: 39847`),e([])}):null}}class p{static models=[];static getUrl(){return e.getUrl("/api/tags")}static load(){return this.getUrl()?g.getModels(this.getUrl(),t=>{p.models=t,e.set("models",p.models),s.emit("modelsLoaded",p.models)}):null}static getAll(){return e.get("models")}static getNames(){let t=this.getAll();return t?t.map(t=>t.name):[]}static findModelByName(t){return this.getAll().find(e=>e.name===t)}}class y extends m{constructor(t){super(t,p.getNames()),this.bindEventListeners()}bindEventListeners(){s.listen("modelsLoaded",this.handleModelsLoaded.bind(this))}handleModelsLoaded(){this.setItems(p.getNames())}static getModels(){return p.getNames()}}class b{static async updateChat(t,e){Object.assign(t,e),await t.save(),s.emit("chatUpdated",t)}static async createChat(t){t||(t={}),t.title||(t.title="Untitled"),t.model||(t.model=e.getModel());let i=await new d(t).create();return e.setCurrentChatId(i.id),s.emit("chatCreated",i),s.emit("chatSelected",i),i}static async deleteChatMessage(e){t.show("Deleted message").autoDismiss(),(await o.get(e)).delete()}static async deleteChat(t){await t.delete(),e.getCurrentChatId()===t.id&&e.setCurrentChatId(null),s.emit("chatDeleted",t)}static async getCurrentChat(){let t=this.getCurrentChatId();return t?await d.get(t):null}static getCurrentChatId(){return e.get("currentChatId")}static async setCurrentChat(t){e.setCurrentChatId(t.id),s.emit("chatSelected",t)}static async setCurrentChatId(t){let e=await d.get(t);e&&await this.setCurrentChat(e)}static async clearChats(){e.setCurrentChatId(null),await d.clear(),s.emit("chatsCleared")}}class v{constructor(t,e,s){this.chat=t,this.chatList=e,this.content=document.getElementById("chat-list-item-template").content.cloneNode(!0),this.element=this.content.querySelector(".chat-list-item"),this.element.title=this.chat.title,this.element.data={id:this.chat.id},this.element.classList.add(`chat${this.chat.id}`),!0===s&&this.element.classList.add("selected"),this.setTitle(),this.bindEventListeners()}render(){}bindEventListeners(){this.element.addEventListener("mouseover",this.onMouseover.bind(this)),this.element.addEventListener("mouseout",this.onMouseout.bind(this)),this.element.addEventListener("click",this.onClick.bind(this)),this.element.querySelector(".list-item-delete").addEventListener("click",this.deleteChat.bind(this))}onMouseover(){this.element.classList.add("hover")}onMouseout(){this.element.classList.remove("hover")}onClick(){this.chatList.selectChat(this.chat.id)}setTitle(){this.content.querySelector(".chat-title").textContent=this.chat.title}deleteChat(){b.deleteChat(this.chat),this.element.remove()}}class C{constructor(t){this.listItems=document.querySelectorAll(t),this.draggedItem=null,this.initializeDragAndDrop()}initializeDragAndDrop(){this.listItems.forEach(t=>{t.addEventListener("dragstart",this.handleDragStart.bind(this,t)),t.addEventListener("dragover",this.handleDragOver.bind(this)),t.addEventListener("drop",this.handleDrop.bind(this,t)),t.addEventListener("dragend",this.handleDragEnd.bind(this))})}handleDragStart(t){this.draggedItem=t}handleDragOver(t){t.preventDefault()}handleDrop(t){if(t!==this.draggedItem){let e=t.innerHTML;t.innerHTML=this.draggedItem.innerHTML,this.draggedItem.innerHTML=e,console.debug("dnd drop")}}handleDragEnd(){this.draggedItem=null}}class w{constructor(){this.element=document.getElementById("chat-list"),this.template=document.getElementById("chat-list-item-template").content,this.bindEventListeners(),b.getCurrentChat().then(t=>{this.chat=t})}bindEventListeners(){s.listen("chatCreated",this.handleChatCreated.bind(this)),s.listen("chatDeleted",this.handleChatDeleted.bind(this)),s.listen("chatsCleared",this.handleChatsCleared.bind(this)),s.listen("chatUpdated",this.handleChatUpdated.bind(this)),s.listen("chatSelected",this.handleChatSelected.bind(this))}async selectChat(t){await b.setCurrentChatId(t)}handleChatCreated(t){this.appendChat(t,!0)}handleChatDeleted(t){this.chat?.id===t.id&&(this.chat=null),this.element.querySelector(`.chat${t.id}`)?.remove()}handleChatsCleared(){this.element.querySelectorAll(".chat-list-item").forEach(t=>t.remove())}handleChatUpdated(t){let e=this.element.querySelector(`.chat${t.id} .chat-title`);e&&(e.textContent=t.title)}handleChatSelected(t){if(this.chat){let t=this.element.querySelector(`.chat${this.chat.id}`);t&&t.classList.remove("selected")}let e=this.element.querySelector(`.chat${t.id}`);e&&e.classList.add("selected"),this.chat=t}render(){let t=b.getCurrentChatId();this.element.innerHTML="",d.getAll().then(e=>{e.forEach(e=>{let s=e.id===t;this.appendChat(e,s)}),new C(".chat-list-item")})}appendChat(t,e){let s=new v(t,this,e);return this.element.appendChild(s.element),s}}class E{constructor(){this.button=document.querySelector("#export-button"),this.bindEventListeners()}bindEventListeners(){this.button.addEventListener("click",()=>{this.exportChat(),this.exportChatMessages()})}async exportChat(){let t=await d.export();t.onsuccess=function(){let e=JSON.stringify(t.result,2),s=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download="chats.json",a.click(),URL.revokeObjectURL(i)},t.onerror=function(t){console.error("Error reading data: ",t.target.errorCode)}}async exportChatMessages(){let t=await o.export();t.onsuccess=function(){let e=JSON.stringify(t.result,2),s=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download="chat_messages.json",a.click(),URL.revokeObjectURL(i)},t.onerror=function(t){console.error("Error reading data: ",t.target.errorCode)}}}class L{set(t,e){try{let s=JSON.stringify(e);localStorage.setItem(t,s)}catch(t){console.error("Error saving to localStorage",t)}}get(t,e=null){try{let s=localStorage.getItem(t);return null!==s?JSON.parse(s):e}catch(t){return console.error("Error reading from localStorage",t),e}}remove(t){try{localStorage.removeItem(t)}catch(t){console.error("Error removing from localStorage",t)}}}class S{constructor(){this.settings=new L,this.chatList=new w,this.element=document.getElementById("sidebar"),this.modelList=new y(this.element.querySelector(".chat-model-list")).onClick(this.handleModelSelected.bind(this)),this.hamburgerButton=document.getElementById("hamburger-menu"),this.searchButton=document.getElementById("search-button"),this.downloadChatsButton=new E,this.searchRow=document.getElementById("search-row"),this.searchInput=document.getElementById("search-input"),!0===this.settings.get("sidebar-collapsed")&&this.element.classList.add("collapsed"),this.bindEventListeners(),this.render()}render(){this.chatList.render()}async handleModelSelected(t){let e=await b.getCurrentChat();this.modelName.textContent=t,b.updateChat(e,{model:t})}bindEventListeners(){s.listen("chatSelected",this.handleChatSelected),this.searchButton.addEventListener("click",this.toggleSearch.bind(this)),this.searchInput.addEventListener("keypress",a(this.performSearch.bind(this),50)),this.searchInput.addEventListener("keyup",a(this.performSearch.bind(this),50)),this.hamburgerButton.addEventListener("click",this.toggle.bind(this))}handleChatSelected=t=>{let e=this.element.querySelector(`chat${t.id}`);e&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};toggleSearch(){document.getElementById("search-row").classList.toggle("hidden"),this.searchInput.focus()}performSearch(){let t=this.searchInput.value.trim().replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\s+/g,".*"),e=t.length>2,s=RegExp(t,"i");console.log(`Search ${t}`),d.getAll().then(t=>{let i=t.filter(t=>{let i=s.test(t.title);return e&&(i||=s.test(t.content)),i}).map(t=>t.id);this.element.querySelectorAll(".chat-list-item").forEach(t=>{i.includes(t.data.id)?t.classList.remove("hidden"):t.classList.add("hidden")})})}toggle(){this.element.classList.toggle("collapsed"),this.hamburgerButton.classList.toggle("collapsed"),this.element.classList.contains("collapsed")?this.settings.set("sidebar-collapsed",!0):this.settings.set("sidebar-collapsed",!1)}}class I{constructor(){document.addEventListener("click",e=>{if(e.target.classList.contains("copy-button")){let s=e.target.getAttribute("data-target");if(!s){console.error("The data-target attribute is not set");return}let i=document.getElementById(s).innerText,a=document.createElement("textarea");a.value=i,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),t.show("Text copied to clipboard").autoDismiss()}})}}class f{constructor(){document.addEventListener("click",t=>{if(t.target.classList.contains("download-button")){let e=t.target.getAttribute("data-target");this.downloadElementContent(e,"chat.html")}})}downloadElementContent(t,e){let s=document.getElementById(t);if(!s){console.error("Element not found");return}let i=s.innerText,a=new Blob([i],{type:"text/html"}),n=document.createElement("a");n.href=URL.createObjectURL(a),n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(n.href)}}class M{constructor(){this.buttonSelector=".drop-down-menu",this.dropDownMenus=document.querySelectorAll(this.buttonSelector),this.init()}init(){document.addEventListener("click",t=>{let e=t.target.closest(this.buttonSelector);if(e){let t=e.querySelector(".drop-down-menu-items");t&&this.toggleMenu(t)}})}toggleMenu(t){t.classList.toggle("hidden"),t.classList.toggle("visible")}}class B{constructor(t){this.domId=t.domId,this.templateId=t.templateId,this.modal=this.createDialogElement(),this.titleElement=this.modal.querySelector(".modal-title"),this.closeButton=this.modal.querySelector(".button-close"),this.closeButton.onclick=()=>this.hide(),this._bindEventListeners(),this.setTitle(t.title)}setTitle(t){this.titleElement.textContent=t}_bindEventListeners(){this.modal.addEventListener("click",t=>{t.target==this.modal&&this.hide()}),window.addEventListener("keydown",t=>{"Escape"===t.key&&this.hide()})}createDialogElement(){let t=document.getElementById(this.templateId);if(!t){console.error(`Template with ID ${this.templateId} not found.`);return}let e=t.content.cloneNode(!0).firstElementChild;if(e.id=this.domId,!e){console.error(`No modal element found in the template with ID ${this.templateId}.`);return}return document.body.appendChild(e),e}show(){this.handleShow()}hide(){this.handleHide()}handleShow(){this.modal.classList.add("show")}handleHide(){this.modal.classList.remove("show")}}class k extends B{constructor(t){super(t),this.showButton=document.getElementById(t.buttonId),this.urlInput=this.modal.querySelector("#input-url"),this.modelInput=this.modal.querySelector("#input-model"),this.systemPromptInput=this.modal.querySelector("#input-system-prompt"),this.modelParametersInput=this.modal.querySelector("#input-model-parameters"),this.refreshModelsButton=this.modal.querySelector(".refresh-models-button"),this.modelList=new y(this.modal.querySelector("#model-list")),this.bindEventListeners()}getSelected(){return e.getModel()}bindEventListeners(){this.urlInput.addEventListener("blur",this.handleUrlUpdated.bind(this)),this.systemPromptInput.addEventListener("blur",this.handleSystemPromptUpdated.bind(this)),this.modelParametersInput.addEventListener("blur",()=>this.handleModelParametersUpdated.bind(this)),this.modelList.onClick(this.handleModelUpdated.bind(this)),this.showButton.addEventListener("click",this.show.bind(this)),this.refreshModelsButton.addEventListener("click",this.refreshModels.bind(this)),this.closeButton.addEventListener("click",this.hide.bind(this))}handleSystemPromptUpdated(){e.setSystemPrompt(this.systemPromptInput.value.trim())}handleModelUpdated(){e.setModel(this.modelList.getSelected())}handleModelParametersUpdated(){let t=this.modelParametersInput.value.trim();if(""!==t)try{let s=JSON.parse(t),i=JSON.stringify(s,2);e.setModelParameters(s),this.modelParametersInput.value=i,this.modelParametersInput.classList.remove("error")}catch(t){"SyntaxError"===t.name?this.modelParametersInput.classList.add("error"):console.error(t)}}handleUrlUpdated(){let t=this.urlInput.value.trim();e.setUrl(t)}show(){this.loadSettings(),p.load(),this.handleShow()}refreshModels(){p.getUrl()?p.load():t.show("Please update the URL in the settings to continue.")}loadSettings(){this.modelList.setSelected(this.getSelected()),this.urlInput.value=e.getUrl();let t=e.getModelParameters();t&&(this.modelParametersInput.value=JSON.stringify(t,2))}}class x extends k{constructor(t){super(t)}getSelected(){return this.chat?.model}async handleSystemPromptUpdated(){this.chat.systemPrompt=this.systemPromptInput.value.trim(),await this.chat.save()}async handleModelUpdated(){this.chat.model=this.modelList.getSelected(),await this.chat.save()}async handleModelParametersUpdated(){this.chat.modelParameters=this.modelParametersInput.value.trim(),await this.chat.save()}async handleUrlUpdated(){this.chat.url=this.urlInput.value.trim(),await this.chat.save()}loadSettings(){b.getCurrentChat().then(t=>{this.modelList.setSelected(t.model),this.chat=t,this.urlInput.value=this.chat.url||e.getUrl();let s=this.chat.modelParameters||e.getModelParameters();s&&(this.modelParametersInput.value=JSON.stringify(s,2))})}}class T{constructor(t,e,s){if(!e)throw Error("No target element specified");this.active=!1,this.onSelected=s,this.input=t,this.target=e,this.bindEventListeners()}bindEventListeners(){this.input.addEventListener("input",()=>this.handleInput()),this.input.addEventListener("keydown",t=>this.handleKeydown(t)),s.listen("select",this.handleSelected.bind(this),this.ul)}handleInput(){let t=this.getText();if("@"===t[t.length-1]&&this.showTarget(),this.active){let t=this.getSearchTerm();this.target.filter(t)||this.hideTarget()}}getText(){return this.input.value.trim()}getSearchTerm(){let t=this.getText(),e=t.lastIndexOf("@");return -1!==e?t.substring(e+1):null}handleKeydown(t){let e=t.key;if(9==t.which&&this.active){let e=this.target.element.querySelector("li:not(.hidden)")?.textContent;this.handleSelected(e),t.preventDefault()}else(" "===e||"Enter"===e||"Escape"===e)&&this.hideTarget()}handleSelected(t){if(null==t||!this.active)return;let e=this.getText(),s=e.lastIndexOf("@");-1!==s&&(this.input.value=e.substring(0,s+1)+t,this.input.focus(),this.input.setSelectionRange(this.input.value.length,this.input.value.length),this.hideTarget())}showTarget(){this.active=!0,this.target.element.classList.add("active"),this.target.show()}hideTarget(){this.active=!1,this.target.element.classList.remove("active"),this.target.hide()}}class q{static exportChat(t,e){let s=t.jsonify(),i=new Blob([s],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(i),a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(a.href)}}class U{constructor(t){this.element=t,t.hoverable=this,this.bindEventListeners()}bindEventListeners(){this.element.addEventListener("mouseover",()=>this.onMouseover()),this.element.addEventListener("mouseout",()=>this.onMouseout())}onMouseover(){this.element.classList.add("hover")}onMouseout(){this.element.classList.remove("hover")}}class D{constructor(){this.defaultTitle="Untitled",this.element=document.getElementById("chat-title"),this.bindEventListeners(),this.render()}render(){b.getCurrentChat().then(t=>{this.chat=t,this.setTitle(t?.title)})}setTitle(t){this.element.textContent=t||this.defaultTitle}focus(){document.activeElement!==this.element&&this.element.focus()}bindEventListeners(){s.listen("chatDeleted",this.handleChatDeleted.bind(this)),s.listen("chatSelected",this.handleChatSelected.bind(this)),this.element.addEventListener("blur",this.handleSave.bind(this)),this.element.addEventListener("keypress",t=>{"Enter"===t.key&&(t.preventDefault(),this.element.blur())})}handleChatSelected(t){this.chat=t,this.setTitle(t.title)}handleChatDeleted(t){t.id===this.chat.id&&this.setTitle(this.defaultTitle)}async handleSave(){let t=this.element.textContent.trim();0===t.length?(t=this.defaultTitle,this.element.classList.add("error")):this.element.classList.remove("error");let e=await b.getCurrentChat();e?await b.updateChat(e,{title:t}):await b.createChat({title:t})}}class ${constructor(){this.chatHistory=document.getElementById("chat-history"),this.messageInput=document.getElementById("message-input"),this.sendButton=document.getElementById("send-button"),this.abortButton=document.getElementById("abort-button")}}class P{constructor(){this.chatTitle=new D,this.chatForm=new $,this.chatHistory=document.getElementById("chat-history"),this.messageInput=document.getElementById("message-input"),this.editChatButton=document.getElementById("edit-chat-button"),this.chatModel=document.getElementById("chat-model"),this.modelName=this.chatModel.querySelector(".chat-model-name"),this.scrollToTopButton=document.getElementById("scroll-to-top-button"),this.scrollToEndButton=document.getElementById("scroll-to-end-button"),this.deleteChatButton=document.getElementById("delete-chat-button"),this.exportChatButton=document.getElementById("export-chat-button"),this.modelList=new y(this.chatModel.querySelector(".chat-model-list")).onClick(this.handleModelSelected.bind(this)),new T(this.messageInput,this.modelList,this.handleModelSelected.bind(this)),b.getCurrentChat().then(t=>{t&&(this.chat=t,this.render())}),this.bindEventListeners()}render(){this.chatHistory.innerText="",this.chat&&(this.modelName.textContent=this.chat.model,this.modelList.setSelected(this.chat.model),this.chat.getMessages().then(t=>{t.forEach(t=>{this.createMessageDiv(t)})}),this.scrollToEnd()),this.messageInput.focus()}bindEventListeners(){s.listen("chatSelected",this.handleChatSelected.bind(this)),s.listen("chatDeleted",this.handleChatDeleted.bind(this)),this.scrollToTopButton.addEventListener("click",this.scrollToTop.bind(this)),this.scrollToEndButton.addEventListener("click",this.scrollToEnd.bind(this)),this.editChatButton.addEventListener("click",this.handleEditChat.bind(this)),this.deleteChatButton.addEventListener("click",this.handleDeleteChat.bind(this)),this.exportChatButton.addEventListener("click",()=>{q.exportChat(this.chat,`chat-${this.chat.id}.json`)}),this.currentMessage=this.chatHistory.querySelector(".selected"),document.addEventListener("keydown",t=>{let e,s;"ArrowDown"===t.key?(e=this.currentMessage?this.currentMessage.nextElementSibling:this.chatHistory.firstElementChild)&&(this.currentMessage&&this.currentMessage.classList.remove("hover"),e.classList.add("hover"),this.currentMessage=e,this.currentMessage.scrollIntoView({behavior:"smooth",block:"nearest"})):"ArrowUp"===t.key&&((s=this.currentMessage?this.currentMessage.previousElementSibling:this.chatHistory.lastElementChild)&&(this.currentMessage&&this.currentMessage.classList.remove("hover"),s.classList.add("hover")),this.currentMessage=s,this.currentMessage.scrollIntoView({behavior:"smooth",block:"nearest"}))})}createMessageDiv(e){let s=`chat-message-${e.id}`,i=e.role,a=e.content,n=document.getElementById("chat-message-template").content.cloneNode(!0),r=n.querySelector(".chat-message"),l=n.querySelector(".chat-message-text"),o=n.querySelector(".delete-chat-message-button"),d=n.querySelector(".copy-chat-message-button .copy-button"),h=n.querySelector(".good-chat-message-button"),c=n.querySelector(".bad-chat-message-button"),u=n.querySelector(".flag-chat-message-button");return"bad"==e.quality?c.classList.add("selected"):"good"==e.quality?h.classList.add("selected"):"flagged"==e.quality&&u.classList.add("selected"),r.classList.add(`${i}-chat-message`),r.id=s,l.textContent=a,r.spellcheck=!1,this.chatHistory.appendChild(r),r.dataset.id=e.id,new U(r),o.addEventListener("click",async()=>{await b.deleteChatMessage(e.id),r.remove()}),d.dataset.target=s,u.addEventListener("click",async()=>{t.show("Flagged message").autoDismiss(),e.quality="flagged",await e.save()}),h.addEventListener("click",async()=>{t.show("Marked message as good").autoDismiss(),e.quality="good",await e.save()}),c.addEventListener("click",async()=>{t.show("Marked message as bad").autoDismiss(),e.quality="bad",await e.save()}),{element:r,textElement:l}}handleChatDeleted(t){t.id===this.chat?.id?this.chat=null:this.chat=t,this.render()}async handleModelSelected(t){let e=await b.getCurrentChat();this.modelName.textContent=t,b.updateChat(e,{model:t})}handleChatSelected(t){this.chat=t,this.render()}handleEditChat(){this.chatTitle.focus(),event.stopPropagation()}async handleDeleteChat(){let t=await b.getCurrentChat();t&&await b.deleteChat(t)}scrollToTop(){this.chatHistory.scrollTop=0}scrollToEnd(){this.chatHistory.scrollTop=this.chatHistory.scrollHeight}}class A{static run(){return t.initialize(),new A}constructor(){this.sidebar=new S,this.chatArea=new P,this.api=new g,this.settingsDialog=new k({domId:"settings-dialog",buttonId:"settings-button",title:"Application settings",templateId:"settings-dialog-template"}),this.chatSettingsDialog=new x({domId:"chat-settings-dialog",buttonId:"chat-settings-button",title:"Chat settings",templateId:"settings-dialog-template"}),this.downloadButton=new f,this.copyButton=new I,this.dropDownMenu=new M,this.newChatButton=document.querySelector("#new-chat-button"),this.clearButton=document.querySelector("#clear-button"),this.initializeElements(),this.bindEventListeners(),this.logInitialization()}initializeElements(){this.abortButton=document.getElementById("abort-button"),this.messageInput=document.getElementById("message-input"),this.chatHistory=document.getElementById("chat-history")}logInitialization(){console.log(`~~~~
Chat
~~~~
Model:       ${e.getModel()}
URL:         ${e.getUrl()}
Chat:        ${e.getCurrentChatId()}
Parameters:  ${JSON.stringify(e.getModelParameters())}
`)}bindEventListeners(){s.listen("chatSelected",this.handleChatSelected),this.newChatButton.addEventListener("click",this.handleNewChat.bind(this)),this.clearButton.addEventListener("click",this.handleClear.bind(this)),this.abortButton.addEventListener("click",this.handleAbort.bind(this)),this.messageInput.addEventListener("keypress",this.handleKeyPress.bind(this))}handleChatSelected=t=>{window.history.pushState({},"",`/chats/${t.id}`)};handleAbort=()=>{this.api.abort(),this.enableForm(),console.log("Request aborted")};handleKeyPress=t=>{"Enter"!==t.key||t.shiftKey||this.sendMessage()};enableForm(){i.hideElement(this.abortButton).enableInput(this.messageInput),this.messageInput.focus()}disableForm(){i.showElement(this.abortButton).disableInput(this.messageInput)}async sendMessage(){let s=this.messageInput.value.trim(),i=await b.getCurrentChat(),a=e.getUrl("/api/chat");if(!a)return t.show("Please update the URL in the settings to continue. "),null;if(s){this.messageInput.value="",i||(i=await b.createChat({title:"Untitled",model:e.getModel()}));let t=await i.addMessage({role:"user",content:s}),n=await i.addMessage({role:"assistant",content:""}),r=e.getSystemPrompt(),l=e.getModelParameters();this.disableForm(),this.createChatMessage(t);let o=this.createChatMessage(n),d={chat:i,userMessage:t,systemMessage:n,responseElement:o},h=await this.api.makeRequest(i,this.getModelFromText(t.content)||i.model,t,r,l);o.textElement.innerHTML='<div class="waiting"></div>',this.chatArea.scrollToEnd(),this.api.send(a,h,(t,e)=>this.handleResponse(t,e,d),(t,e)=>this.handleResponseError(t,e),(t,e)=>this.handleDone(t,e,d))}}getModelFromText(t){if(null===t)return null;let e=null,s=t.match(/@(\S+)/g);return s&&(e=s[s.length-1].slice(1)),e}createChatMessage(t){return this.chatArea.createMessageDiv(t)}handleResponse(t,e,s){let i=s.responseElement,a=this.sanitizeContent(e);s.systemMessage.content+=a,i.textElement.textContent+=a,this.chatArea.scrollToEnd()}handleResponseError(t,e){void 0!==e&&"AbortError"!==e.name&&console.error(`Error: ${e.message}`),this.chatArea.scrollToEnd(),this.enableForm()}async handleDone(t,e,s){let i=s.chat;console.log(`Chat ${i.id} done`),await s.systemMessage.save(),this.enableForm()}async handleNewChat(){await b.createChat()}async handleClear(){await b.clearChats()}sanitizeContent=t=>t;getIdParam=()=>new URL(window.location.href).pathname.split("/").pop()}(async function(){await d.initialize(),await o.initialize()})().then(()=>{A.run()});
//# sourceMappingURL=index.3f2c7e47.js.map
